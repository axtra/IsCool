<?php

/*
 * This file is part of the symfony package.
 * (c) Fabien Potencier <fabien.potencier@symfony-project.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

/**
 * sfValidatedFile represents a validated uploaded file.
 *
 * @package    symfony
 * @subpackage validator
 * @author     Fabien Potencier <fabien.potencier@symfony-project.com>
 * @version    SVN: $Id: sfValidatedFile.class.php 30915 2010-09-15 17:10:37Z Kris.Wallsmith $
 */
class sfValidatedFile
{
  protected
    $originalName = '',
    $tempName     = '',
    $savedName    = null,
    $type         = '',
    $size         = 0,
    $path         = null;

  /**
   * Constructor.
   *
   * @param string $originalName  The original file name
   * @param string $type          The file content type
   * @param string $tempName      The absolute temporary path to the file
   * @param int    $size          The file size (in bytes)
   * @param string $path          The path to save the file (optional).
   */
  public function __construct($originalName, $type, $tempName, $size, $path = null)
  {
    $this->originalName = $originalName;
    $this->tempName = $tempName;
    $this->type = $type;
    $this->size = $size;
    $this->path = $path;
  }

  /**
   * Returns the name of the saved file.
   */
  public function __toString()
  {
    return null === $this->savedName ? '' : $this->savedName;
  }

  /**
   * Saves the uploaded file.
   *
   * This method can throw exceptions if there is a problem when saving the file.
   *
   * If you don't pass a file name, it will be generated by the generateFilename method.
   * This will only work if you have passed a path when initializing this instance.
   *
   * @param  string $file      The file path to save the file
   * @param  int    $fileMode  The octal mode to use for the new file
   * @param  bool   $create    Indicates that we should make the directory before moving the file
   * @param  int    $dirMode   The octal mode to use when creating the directory
   *
   * @return string The filename without the $this->path prefix
   *
   * @throws Exception
   */
  public function save($file = null, $fileMode = 0666, $create = true, $dirMode = 0777)
  {
    if (null === $file)
    {
      $file = $this->generateFilename();
    }

    if ($file[0] != '/' && $file[0] != '\\' && !(strlen($file) > 3 && ctype_alpha($file[0]) && $file[1] == ':' && ($file[2] == '\\' || $file[2] == '/')))
    {
      if (null === $this->path)
      {
        throw new RuntimeException('You must give a "path" when you give a relative file name.');
      }

      $file = $this->path.DIRECTORY_SEPARATOR.$file;
    }

    // get our directory path from the destination filename
    $directory = dirname($file);

    if (!is_readable($directory))
    {
      if ($create && !@mkdir($directory, $dirMode, true))
      {
        // failed to create the directory
        throw new Exception(sprintf('Failed to create file upload directory "%s".', $directory));
      }

      // chmod the directory since it doesn't seem to work on recursive paths
      chmod($directory, $dirMode);
    }

    if (!is_dir($directory))
    {
      // the directory path exists but it's not a directory
      throw new Exception(sprintf('File upload path "%s" exists, but is not a directory.', $directory));
    }

    if (!is_writable($directory))
    {
      // the directory isn't writable
      throw new Exception(sprintf('File upload path "%s" is not writable.', $directory));
    }

    // copy the temp file to the destination file
    copy($this->getTempName(), $file);

    // chmod our file
    chmod($file, $fileMode);

    $this->savedName = $file;

    return null === $this->path ? $file : str_replace($this->path.DIRECTORY_SEPARATOR, '', $file);
  }

  /**
   * Generates a random filename for the current file.
   *
   * @return string A random name to represent the current file
   */
  public function generateFilename()
  {
    return sha1($this->getOriginalName().rand(11111, 99999)).$this->getExtension($this->getOriginalExtension());
  }

  /**
   * Returns the path to use when saving a file with a relative filename.
   *
   * @return string The path to use when saving a file with a relative filename
   */
  public function getPath()
  {
    return $this->path;
  }

  /**
   * Returns the file extension, based on the content type of the file.
   *
   * @param  string $default  The default extension to return if none was given
   *
   * @return string The extension (with the dot)
   */
  public function getExtension($default = '')
  {
    return $this->getExtensionFromType($this->type, $default);
  }

  /**
   * Returns the original uploaded file name extension.
   *
   * @param  string $default  The default extension to return if none was given
   *
   * @return string The extension of the uploaded name (with the dot)
   */
  public function getOriginalExtension($default = '')
  {
    return (false === $pos = strrpos($this->getOriginalName(), '.')) ? $default : substr($this->getOriginalName(), $pos);
  }

  /**
   * Returns true if the file has already been saved.
   *
   * @return Boolean true if the file has already been saved, false otherwise
   */
  public function isSaved()
  {
    return null !== $this->savedName;
  }

  /**
   * Returns the path where the file has been saved
   *
   * @return string The path where the file has been saved
   */
  public function getSavedName()
  {
    return $this->savedName;
  }

  /**
   * Returns the original file name.
   *
   * @return string The file name
   */
  public function getOriginalName()
  {
    return $this->originalName;
  }

  /**
   * Returns the absolute temporary path to the uploaded file.
   *
   * @return string The temporary path
   */
  public function getTempName()
  {
    return $this->tempName;
  }

  /**
   * Returns the file content type.
   *
   * @return string The content type
   */
  public function getType()
  {
    return $this->type;
  }

  /**
   * Returns the size of the uploaded file.
   *
   * @return int The file size
   */
  public function getSize()
  {
    return $this->size;
  }

  /**
   * Returns the extension associated with the given content type.
   *
   * @param  string $type     The content type
   * @param  string $default  The default extension to use
   *
   * @return string The extension (with the dot)
   */
  protected function getExtensionFromType($type, $default = '')
  {
    static $extensions = array(
      'application/andrew-inset' => 'ez',
      'application/appledouble' => 'base64',
      'application/applefile' => 'base64',
      'application/commonground' => 'dp',
      'application/cprplayer' => 'pqi',
      'application/dsptype' => 'tsp',
      'application/excel' => 'xls',
      'application/font-tdpfr' => 'pfr',
      'application/futuresplash' => 'spl',
      'application/hstu' => 'stk',
      'application/hyperstudio' => 'stk',
      'application/javascript' => 'js',
      'application/mac-binhex40' => 'hqx',
      'application/mac-compactpro' => 'cpt',
      'application/mbed' => 'mbd',
      'application/mirage' => 'mfp',
      'application/msword' => 'doc',
      'application/ocsp-request' => 'orq',
      'application/ocsp-response' => 'ors',
      'application/octet-stream' => 'bin',
      'application/oda' => 'oda',
      'application/ogg' => 'ogg',
      'application/pdf' => 'pdf',
      'application/x-pdf' => 'pdf',
      'application/pgp-encrypted' => '7bit',
      'application/pgp-keys' => '7bit',
      'application/pgp-signature' => 'sig',
      'application/pkcs10' => 'p10',
      'application/pkcs7-mime' => 'p7m',
      'application/pkcs7-signature' => 'p7s',
      'application/pkix-cert' => 'cer',
      'application/pkix-crl' => 'crl',
      'application/pkix-pkipath' => 'pkipath',
      'application/pkixcmp' => 'pki',
      'application/postscript' => 'ps',
      'application/presentations' => 'shw',
      'application/prs.cww' => 'cw',
      'application/prs.nprend' => 'rnd',
      'application/quest' => 'qrt',
      'application/rtf' => 'rtf',
      'application/sgml-open-catalog' => 'soc',
      'application/sieve' => 'siv',
      'application/smil' => 'smi',
      'application/toolbook' => 'tbk',
      'application/vnd.3gpp.pic-bw-large' => 'plb',
      'application/vnd.3gpp.pic-bw-small' => 'psb',
      'application/vnd.3gpp.pic-bw-var' => 'pvb',
      'application/vnd.3gpp.sms' => 'sms',
      'application/vnd.acucorp' => 'atc',
      'application/vnd.adobe.xfdf' => 'xfdf',
      'application/vnd.amiga.amu' => 'ami',
      'application/vnd.blueice.multipass' => 'mpm',
      'application/vnd.cinderella' => 'cdy',
      'application/vnd.cosmocaller' => 'cmc',
      'application/vnd.criticaltools.wbs+xml' => 'wbs',
      'application/vnd.curl' => 'curl',
      'application/vnd.data-vision.rdz' => 'rdz',
      'application/vnd.dreamfactory' => 'dfac',
      'application/vnd.fsc.weblauch' => 'fsc',
      'application/vnd.genomatix.tuxedo' => 'txd',
      'application/vnd.hbci' => 'hbci',
      'application/vnd.hhe.lesson-player' => 'les',
      'application/vnd.hp-hpgl' => 'plt',
      'application/vnd.ibm.electronic-media' => 'emm',
      'application/vnd.ibm.rights-management' => 'irm',
      'application/vnd.ibm.secure-container' => 'sc',
      'application/vnd.ipunplugged.rcprofile' => 'rcprofile',
      'application/vnd.irepository.package+xml' => 'irp',
      'application/vnd.jisp' => 'jisp',
      'application/vnd.kde.karbon' => 'karbon',
      'application/vnd.kde.kchart' => 'chrt',
      'application/vnd.kde.kformula' => 'kfo',
      'application/vnd.kde.kivio' => 'flw',
      'application/vnd.kde.kontour' => 'kon',
      'application/vnd.kde.kpresenter' => 'kpr',
      'application/vnd.kde.kspread' => 'ksp',
      'application/vnd.kde.kword' => 'kwd',
      'application/vnd.kenameapp' => 'htke',
      'application/vnd.kidspiration' => 'kia',
      'application/vnd.kinar' => 'kne',
      'application/vnd.llamagraphics.life-balance.desktop' => 'lbd',
      'application/vnd.llamagraphics.life-balance.exchange+xml' => 'lbe',
      'application/vnd.lotus-1-2-3' => 'wks',
      'application/vnd.mcd' => 'mcd',
      'application/vnd.mfmp' => 'mfm',
      'application/vnd.micrografx.flo' => 'flo',
      'application/vnd.micrografx.igx' => 'igx',
      'application/vnd.mif' => 'mif',
      'application/vnd.mophun.application' => 'mpn',
      'application/vnd.mophun.certificate' => 'mpc',
      'application/vnd.mozilla.xul+xml' => 'xul',
      'application/vnd.ms-artgalry' => 'cil',
      'application/vnd.ms-asf' => 'asf',
      'application/vnd.ms-excel' => 'xls',
      'application/vnd.ms-excel.sheet.macroenabled.12' => 'xlsm',
      'application/vnd.ms-lrm' => 'lrm',
      'application/vnd.ms-powerpoint' => 'ppt',
      'application/vnd.ms-project' => 'mpp',
      'application/vnd.ms-tnef' => 'base64',
      'application/vnd.ms-works' => 'base64',
      'application/vnd.ms-wpl' => 'wpl',
      'application/vnd.mseq' => 'mseq',
      'application/vnd.nervana' => 'ent',
      'application/vnd.nokia.radio-preset' => 'rpst',
      'application/vnd.nokia.radio-presets' => 'rpss',
      'application/vnd.oasis.opendocument.text' => 'odt',
      'application/vnd.oasis.opendocument.text-template' => 'ott',
      'application/vnd.oasis.opendocument.text-web' => 'oth',
      'application/vnd.oasis.opendocument.text-master' => 'odm',
      'application/vnd.oasis.opendocument.graphics' => 'odg',
      'application/vnd.oasis.opendocument.graphics-template' => 'otg',
      'application/vnd.oasis.opendocument.presentation' => 'odp',
      'application/vnd.oasis.opendocument.presentation-template' => 'otp',
      'application/vnd.oasis.opendocument.spreadsheet' => 'ods',
      'application/vnd.oasis.opendocument.spreadsheet-template' => 'ots',
      'application/vnd.oasis.opendocument.chart' => 'odc',
      'application/vnd.oasis.opendocument.formula' => 'odf',
      'application/vnd.oasis.opendocument.database' => 'odb',
      'application/vnd.oasis.opendocument.image' => 'odi',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document' => 'docx',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.template' => 'dotx',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' => 'xlsx',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation' => 'pptx',
      'application/vnd.palm' => 'prc',
      'application/vnd.picsel' => 'efif',
      'application/vnd.pvi.ptid1' => 'pti',
      'application/vnd.quark.quarkxpress' => 'qxd',
      'application/vnd.sealed.doc' => 'sdoc',
      'application/vnd.sealed.eml' => 'seml',
      'application/vnd.sealed.mht' => 'smht',
      'application/vnd.sealed.ppt' => 'sppt',
      'application/vnd.sealed.xls' => 'sxls',
      'application/vnd.sealedmedia.softseal.html' => 'stml',
      'application/vnd.sealedmedia.softseal.pdf' => 'spdf',
      'application/vnd.seemail' => 'see',
      'application/vnd.smaf' => 'mmf',
      'application/vnd.sun.xml.calc' => 'sxc',
      'application/vnd.sun.xml.calc.template' => 'stc',
      'application/vnd.sun.xml.draw' => 'sxd',
      'application/vnd.sun.xml.draw.template' => 'std',
      'application/vnd.sun.xml.impress' => 'sxi',
      'application/vnd.sun.xml.impress.template' => 'sti',
      'application/vnd.sun.xml.math' => 'sxm',
      'application/vnd.sun.xml.writer' => 'sxw',
      'application/vnd.sun.xml.writer.global' => 'sxg',
      'application/vnd.sun.xml.writer.template' => 'stw',
      'application/vnd.sus-calendar' => 'sus',
      'application/vnd.vidsoft.vidconference' => 'vsc',
      'application/vnd.visio' => 'vsd',
      'application/vnd.visionary' => 'vis',
      'application/vnd.wap.sic' => 'sic',
      'application/vnd.wap.slc' => 'slc',
      'application/vnd.wap.wbxml' => 'wbxml',
      'application/vnd.wap.wmlc' => 'wmlc',
      'application/vnd.wap.wmlscriptc' => 'wmlsc',
      'application/vnd.webturbo' => 'wtb',
      'application/vnd.wordperfect' => 'wpd',
      'application/vnd.wqd' => 'wqd',
      'application/vnd.wv.csp+wbxml' => 'wv',
      'application/vnd.wv.csp+xml' => '8bit',
      'application/vnd.wv.ssp+xml' => '8bit',
      'application/vnd.yamaha.hv-dic' => 'hvd',
      'application/vnd.yamaha.hv-script' => 'hvs',
      'application/vnd.yamaha.hv-voice' => 'hvp',
      'application/vnd.yamaha.smaf-audio' => 'saf',
      'application/vnd.yamaha.smaf-phrase' => 'spf',
      'application/vocaltec-media-desc' => 'vmd',
      'application/vocaltec-media-file' => 'vmf',
      'application/vocaltec-talker' => 'vtk',
      'application/watcherinfo+xml' => 'wif',
      'application/wordperfect5.1' => 'wp5',
      'application/x-123' => 'wk',
      'application/x-7th_level_event' => '7ls',
      'application/x-authorware-bin' => 'aab',
      'application/x-authorware-map' => 'aam',
      'application/x-authorware-seg' => 'aas',
      'application/x-bcpio' => 'bcpio',
      'application/x-bleeper' => 'bleep',
      'application/x-bzip2' => 'bz2',
      'application/x-cdlink' => 'vcd',
      'application/x-chat' => 'chat',
      'application/x-chess-pgn' => 'pgn',
      'application/x-compress' => 'z',
      'application/x-cpio' => 'cpio',
      'application/x-cprplayer' => 'pqf',
      'application/x-csh' => 'csh',
      'application/x-cu-seeme' => 'csm',
      'application/x-cult3d-object' => 'co',
      'application/x-debian-package' => 'deb',
      'application/x-director' => 'dcr',
      'applicat